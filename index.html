<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<style>
/* Configuraci칩n general de la web */
body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #001f3f; color: #fff; }

.controles {
  text-align: center;
  background: rgba(255, 255, 255, 0.1);
  padding: 25px;
  border-radius: 15px;
  width: 85%;
  margin: 0 auto 20px auto;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.titulo-web {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 20px;
  color: #00b4d8;
  text-transform: uppercase;
  letter-spacing: 1px;
}

#nombreArchivo {
  padding: 12px;
  width: 450px;
  border-radius: 8px;
  border: 2px solid #00b4d8;
  margin-bottom: 15px;
  font-size: 14px;
  background: #f8f9fa;
  color: #333;
  text-align: center;
  font-weight: bold;
}

.ejemplos-contenedor {
  margin-bottom: 20px;
  font-size: 14px;
}
.ejemplos-label { font-weight: bold; color: #fff; display: block; margin-bottom: 10px; }

.boton-ejemplo { 
  background: rgba(0, 180, 216, 0.2); 
  padding: 8px 15px; 
  border-radius: 6px; 
  border: 1px solid #00b4d8;
  color: #90e0ef;
  margin: 5px;
  cursor: pointer;
  display: inline-block;
  font-size: 12px;
  transition: 0.2s;
}
.boton-ejemplo:hover { background: #00b4d8; color: #001f3f; }

#textoInforme {
  width: 100%; height: 180px; margin-bottom: 20px; padding: 12px;
  font-family: Arial, sans-serif; font-size: 14px; border-radius: 10px; display: block;
  box-sizing: border-box; border: 1px solid #ccc;
}

.btn-accion { margin: 10px 5px; padding: 12px 25px; font-weight: bold; border-radius: 8px; cursor: pointer; background: #00b4d8; color: #001f3f; border: none; transition: 0.3s; }
.btn-accion:hover { background: #90e0ef; transform: translateY(-2px); }

.autor-web {
  font-size: 18px;
  color: #ffffff;
  margin-top: 25px;
  font-weight: bold;
  font-style: italic;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  display: block;
  opacity: 0.9;
}

/* --- FORMATO HOJA DIN츼MICO --- */
#vistaPrevia {
  width: 215.9mm; 
  min-height: 279.4mm; 
  background: #fff; 
  color: #000;
  margin: 30px auto; 
  padding: 10mm 20mm; 
  font-family: Arial, sans-serif; 
  font-size: 11pt; 
  line-height: 1.2;
  position: relative; 
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

.header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.header-text { text-align: center; font-size: 10pt; line-height: 1.3; }
.armada-bold { font-weight: bold; display: block; }
.header-normal { font-weight: normal; display: block; }

.logo-anchor { width: 120px; text-align: right; }
.logo-estilizado { height: 130px; width: auto; display: inline-block; }

.titulo-principal {
  text-align: center; font-weight: bold; text-decoration: underline;
  display: block; text-transform: uppercase; line-height: 1.1; margin-bottom: 5px; font-size: 11pt;
}

.negrita { font-weight: bold; }
.seccion-titulo { font-weight: bold; display: block; margin-top: 0px; }
.contenido-texto { display: block; margin-bottom: 5px; text-align: justify; }

.contenedor-temp {
  display: grid; grid-template-columns: 290px 10px auto; 
  font-weight: bold; line-height: 1.3; font-size: 11pt;
}

.espacio-arriba { margin-top: 15px; display: block; }

.footer-informe { margin-top: auto; text-align: right; font-size: 8.5pt; padding-top: 20px; }
.footer-bold { font-weight: bold; }
.footer-link-azul { color: #0000FF; text-decoration: underline; }
</style>
</head>

<body>

<div class="controles">
  <div class="titulo-web">
    Centro meteorol칩gico mar칤timo de Puerto Montt<br>
    Creador de Informes meteorol칩gicos en PDF
  </div>
  
  <input type="text" id="nombreArchivo" placeholder="Seleccione un ejemplo o escriba el nombre aqu칤">
  
  <div class="ejemplos-contenedor">
    <span class="ejemplos-label">Seleccione Bah칤a para el nombre del archivo:</span>
    <div class="boton-ejemplo" onclick="setNombre('1.- CHILOE_08_20')">CHILOE 08 A 20</div>
    <div class="boton-ejemplo" onclick="setNombre('2.- CANAL CHACAO')">CANAL CHACAO</div>
    <div class="boton-ejemplo" onclick="setNombre('3.- BOCA DE GUAFO')">BOCA DE GUAFO</div>
    <div class="boton-ejemplo" onclick="setNombre('4.- AYS칄N_CHACABUCO')">AYS칄N A CHACABUCO</div>
    <div class="boton-ejemplo" onclick="setNombre('5.- GOLFO DE PENAS')">GOLFO DE PENAS</div>
    <div class="boton-ejemplo" onclick="setNombre('6.- PUERTO MONTT')">PUERTO MONTT</div>
    <div class="boton-ejemplo" onclick="setNombre('7.- MAULL칈N')">MAULL칈N</div>
    <div class="boton-ejemplo" onclick="setNombre('QUELLON_MELINKA_08_20')">QUELLON_MELINKA 08 A 20</div>
    <div class="boton-ejemplo" onclick="setNombre('1.- CHILOE_20_08')">CHILOE 20 A 08</div>
    <div class="boton-ejemplo" onclick="setNombre('5.- CAPUERTOMAU')">BALLESTA</div>
    <div class="boton-ejemplo" onclick="setNombre('QUELLON_MELINKA_20_08')">QUELLON_MELINKA 20A 08</div>
  </div>

  <textarea id="textoInforme" placeholder="Pegue aqu칤 el contenido del informe meteorol칩gico..."></textarea>
  
  <div>
    <button class="btn-accion" onclick="generarVista()">游댌 Ver vista previa</button>
    <button class="btn-accion" onclick="generarPDF('letter')" style="background:#e63946; color:white;">游늯 PDF CARTA</button>
    <button class="btn-accion" onclick="generarPDF('legal')" style="background:#2a9d8f; color:white;">游늯 PDF OFICIO</button>
  </div>

  <div class="autor-web">
    Creado por Cabo 1췈 (Met.) Francisco Salas Mu침oz
  </div>
</div>

<div id="vistaPrevia"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
function setNombre(nombre) {
    document.getElementById('nombreArchivo').value = nombre;
}

function normalizarTextoBase(texto) {
    return texto.toUpperCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, function(match) {
            return match === '\u0303' ? match : ''; 
        })
        .normalize("NFC");
}

function generarVista() {
    let texto = document.getElementById("textoInforme").value.trim();
    if (!texto) return;
    
    texto = normalizarTextoBase(texto);
    let lineas = texto.split("\n").map(l => l.trim()).filter(l => l !== "");
    
    const urlLogo = "https://archive.org/download/escudo-servimet/ESCUDO%20SERVIMET.png";

    let htmlContent = `
    <div class="header-container">
      <div class="header-text">
        <span class="armada-bold">Armada de Chile</span>
        <span class="header-normal">Comandancia en Jefe la Va. Zona Naval</span>
        <span class="header-normal">Gobernaci칩n Mar칤tima de Puerto Montt</span>
        <span class="header-normal">Centro Meteorol칩gico Mar칤timo PMO.</span>
      </div>
      <div class="logo-anchor">
         <img src="${urlLogo}" class="logo-estilizado">
      </div>
    </div>
    `;

    lineas.forEach((linea, index) => {
        let lineaProcesada = linea.replace(/\(MAL TIEMPO\)/g, "<b>(MAL TIEMPO)</b>")
                                  .replace(/\(TEMPORAL\)/g, "<b>(TEMPORAL)</b>")
                                  .replace(/EMITIDO:/g, "<b>EMITIDO:</b>");

        if (index < 2) {
            htmlContent += `<div class="titulo-principal">${lineaProcesada}</div>`;
            if (index === 1) htmlContent += `<span class="espacio-arriba"></span>`; 
        }
        else if (/^(SABADO|DOMINGO|LUNES|MARTES|MIERCOLES|JUEVES|VIERNES)\s+\d+/i.test(linea)) {
            htmlContent += `<span class="espacio-arriba"></span><div class="negrita">${lineaProcesada}</div>`;
        }
        else if (linea.startsWith("SITUACION SINOPTICA:") || linea.startsWith("PRONOSTICO:")) {
            htmlContent += `${linea.startsWith("PRONOSTICO:") ? '<span class="espacio-arriba"></span>' : ''}<div class="seccion-titulo">${lineaProcesada}</div>`;
        }
        else if (linea.includes("(CH") && linea.includes(":")) {
            htmlContent += `<div class="negrita" style="margin-top:5px;">${lineaProcesada}</div>`;
        }
        else if (linea.includes("TEMPERATURA MINIMA PROBABLE") || 
                 linea.includes("TEMPERATURA MAXIMA PROBABLE") || 
                 linea.includes("INDICE DE RADIACION ULTRAVIOLETA")) {
            
            if (linea.includes("TEMPERATURA MINIMA PROBABLE")) {
                htmlContent += `<span class="espacio-arriba"></span>`;
            }

            let partes = linea.split(':');
            htmlContent += `
                <div class="contenedor-temp">
                    <div>${partes[0].trim()}</div>
                    <div>:</div>
                    <div>${partes[1] ? partes[1].trim() : ""}</div>
                </div>`;
        }
        else if (linea.startsWith("PRONOSTICO VALIDO") || /^MET\w{5}/.test(linea)) {
            htmlContent += `<span class="espacio-arriba"></span><div class="negrita">${lineaProcesada}</div>`;
        }
        else {
            htmlContent += `<div class="contenido-texto">${lineaProcesada}</div>`;
        }
    });

    htmlContent += `
    <div class="footer-informe">
      <div class="footer-bold">CENTRO METEOROL칍GICO MAR칈TIMO DE PUERTO MONTT</div>
      <div class="footer-normal">
        <span class="footer-link-azul">http://meteoarmada.directemar.cl // @MetArmada_Pmo</span><br>
        AVENIDA ANGELM칍 2201, PUERTO MONTT<br>
        TEL: (65) 2205174 - 2205123
      </div>
    </div>
    `;

    document.getElementById("vistaPrevia").innerHTML = htmlContent;
}

async function generarPDF(formato) {
    const { jsPDF } = window.jspdf;
    const element = document.getElementById("vistaPrevia");
    
    // Ajuste temporal de la altura de la vista previa para la captura
    let altoMM;
    if (formato === 'legal') {
        altoMM = 355.6;
        element.style.minHeight = "355.6mm";
    } else {
        altoMM = 279.4;
        element.style.minHeight = "279.4mm";
    }

    let nombrePersonalizado = document.getElementById("nombreArchivo").value.trim();
    if (!nombrePersonalizado) nombrePersonalizado = "Informe_Meteorologico";

    const canvas = await html2canvas(element, { scale: 2, useCORS: true });
    const imgData = canvas.toDataURL("image/jpeg", 0.8);
    
    const pdf = new jsPDF("p", "mm", formato);
    pdf.addImage(imgData, "JPEG", 0, 0, 215.9, altoMM);
    pdf.save(nombrePersonalizado + "_" + formato.toUpperCase() + ".pdf");
}
</script>
</body>
</html>
